#!/bin/sh

cleanup() {
  kill $KERNEL_PID
  kill $LAUNCHER_PID
}

trap cleanup INT TERM

start_dispatcher() {
  A="./System/Services/Dispatcher"
  update_wap $A || exit 1
  node $A/main.js &
  KERNEL_PID="$!"
  sleep 1
}

start_launcher() {
  A="./System/Services/Launcher"
  update_wap $A || exit 1
  node $A/main.js &
  LAUNCHER_PID="$!"
}

start_display() {
  A="./System/Services/Display"
  update_wap $A || exit 1
  node $A/main.js &
  DISPLAY_PID="$!"
}

B=`realpath "$0"`
B=`dirname $B`
cd "$B/../../"

export KERNEL_PORT=3000
export KERNEL_WSPORT=3001
export DISPLAYSERVER_PORT=3002
export PATH="$PWD/System/bin:$PATH"

start_dispatcher
start_launcher
start_display

#launch Applications/Terminal.wap

wait $KERNEL_PID
cleanup
